---
  - name: update repositories cache and install NFS in RedHat systems
    yum: name=nfs-utils

  - set_fact: NFS_SERVICE="nfs"

  - set_fact: NFS_SERVICE="nfs-server"
    when: ansible_distribution_major_version >= "7"
 
  - name: Lock NFS ports
    lineinfile:
      dest: /etc/sysconfig/nfs
      regexp: "^#{{item}}"
      line: "{{item}}"
      state: present
    with_items:
    - 'LOCKD_TCPPORT=32803'
    - 'LOCKD_UDPPORT=32769'
    - 'MOUNTD_PORT=892'
    notify:
     - restart rpcbind
     - restart nfs    

  - block:
    - name: Set RPCNFSDARGS
      lineinfile:
        path: /etc/sysconfig/nfs
        regexp: '^RPCNFSDARGS='
        line: RPCNFSDARGS="-N 2 -N 3"
      register: nfs_config

    - name: Restart nfs-config
      service: name=nfs-config state=restarted
      when: nfs_exports_result is changed

    when: nfs_only_v4
      
  - name: Open Firewalld nfs port
    firewalld:
      service: nfs
      permanent: yes
      state: enabled
    ignore_errors: yes      

  - name: Open Firewalld nfs port
    firewalld:
      port: 892/tcp
      permanent: yes
      state: enabled
    ignore_errors: yes
